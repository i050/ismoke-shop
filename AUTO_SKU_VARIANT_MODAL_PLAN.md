# תכנית: פתיחת טופס וריאנט אוטומטית בעת יצירת מוצר פשוט

## תקציר מטרות
- **מטרה עסקית:** להבטיח שלמנהל המוצרים יש שליטה מלאה על הוריאנט הראשון כבר בזמן יצירת מוצר חדש ללא וריאנטים, כולל מלאי, תמונות ושדות משלימים.
- **מטרה חווייתית:** לחסוך צעד מיותר של "ערוך את הוריאנט ברירת המחדל אחרי שנוצר" ולספק חוויית onboarding נוחה יותר ל-Wizard יצירת מוצר.
- **מטרה טכנית:** לשמור על הלוגיקה הקיימת (auto-SKU בשרת) אבל לגרום לצד הלקוח לאסוף את נתוני ההוריאנט לפני שליחת הקריאה, כך שהשרת יקבל SKU מלא במקום דיפולט.

## מצב נוכחי
- במצב `create`, קומפוננטת `ProductSKUs` מציגה info-box שמסביר שוריאנט בסיסי יווצר אוטומטית במידה ולא הוגדרו SKUs.
- מודאל `AddSKUModal` נפתח רק כאשר המשתמש לוחץ ידנית על כפתור "הוסף וריאנט".
- בעת השמירה, אם `skus` הוא מערך ריק והטופס מסמן `hasVariants=false`, השרת (`createProductWithSkus`) יוצר SKU בסיסי עם ערכי ברירת מחדל (שם המוצר, basePrice, stockQuantity מהמוצר) ומעדכן את מלאי המוצר לפי סכימת ה-SKUs (שינוי שבוצע בשלבים הקודמים).
- קיימת ניווט אוטומטי לאחר יצירה (`navigate` ל-`/admin/products/:id/edit`), כך שאחרי שמירה ניתן לערוך את ההוריאנט שנוצר.

## בעיות שהתכנית מטפלת בהן
1. מנהל מוצרים רוצה לקבוע מלאי ותמונות ספציפיות לפני השמירה הראשונה, ולא אחרי.
2. יש רצון להפחית את הסיכוי שהמערכת תיצור SKU דיפולטי שלא משקף את המציאות (מלאי 0 וכו').
3. יש צורך בחוויה רציפה יותר: כאשר הסקשן של וריאנטים נפתח, המשתמש צריך מיד לראות את טופס הוריאנט במקום הודעה כללית.

## עקרונות תכנון
- **שמירה על עקביות UX:** פתיחת מודאל מיידית לא תפריע לזרימה כל עוד היא מתוזמנת לנקודה שבה המשתמש מגיע לסקשן SKUs או כשמתבצע mount בטופס create.
- **אי כפילות:** המודאל צריך להיפתח פעם אחת בלבד אוטומטית; שאר לחיצות בעתיד יהיו לפי התנהגות רגילה.
- **נגישות:** פתיחת המודאל חייבת לעמוד בתקן A11y — פוקוס עובר לבקרת המודאל, ESC סוגר, מקלדת מלאה.
- **התאמה לנתונים קיימים:** המודאל יקבל ערכי ברירת מחדל מתוך שדות הטופס (שם מוצר, basePrice, stockQuantity, תמונות מוצר אם רלוונטי) כדי למזער הקלדה כפולה.
- **בטיחות נתונים:** גם אם המשתמש סוגר את המודאל בלי לשמור, info-box עדיין יסביר שיש ליצור SKU לפני שמירה; השמירה עצמה תוודא שיש לפחות SKU אחד.

## תכנית פעולה בשלבים

### שלב 1: ניתוח קומפוננטות קיימות
1. **ProductForm.tsx**
	- לבדוק איך מועבר `mode` וערכי ברירת המחדל ל-`ProductSKUs`.
	- לאתר את נקודת המגע הראשונה שבה הסקשן `skus` נטען.
2. **ProductSKUs/index.tsx**
	- לזהות את ה-state שמנהל את מודאל הוספת ה-SKU (`isModalOpen`, `editingIndex` וכו').
	- להבין כיצד info-box מוצג כאשר `mode='create'` ו-`value.length === 0`.
3. **AddSKUModal.tsx**
	- לוודא שניתן להזרים ערכי התחלה (props כגון `initialSku` או דומה). במידת הצורך נרחיב את ה-API כדי לתמוך ב-pre-fill מלא (שם, מחיר, מלאי, תמונות).

### שלב 2: הגדרת Pre-fill ל-SKU הראשון
1. בתוך `ProductSKUs`, כאשר `mode === 'create'` וערך הסקשן ריק:
	- לגזור אובייקט בסיסי מתוך טופס המוצר:
	  ```ts
	  const defaultSku = {
		 sku: generateSkuFromName(productName),
		 name: productName,
		 price: basePrice,
		 stockQuantity: stockQuantityFromInventorySection,
		 images: copyOfProductImages,
		 color: '',
		 size: '',
		 isActive: true,
	  };
	  ```
	- הפונקציה `generateSkuFromName` כבר קיימת בצד השרת; בצד הלקוח נשתמש בגרסה פשוטה או נייבא פונקציה קיימת אם יש.
2. המודאל יקבל את הערכים האלה כ־`initialSku`. כאשר המשתמש מאשר, ה-value של RHF יתעדכן עם SKU אחד לפחות.

### שלב 3: טריגר לפתיחת המודאל
1. בעת mount של `ProductSKUs` (או באמצעות `useEffect` שמאזין ל-`mode` ולגודל המערך):
	- אם `mode === 'create'`, `value.length === 0`, וטרם פתחנו מודאל אוטומטי — נקרא לפונקציה `openModal('create', defaultSku)`.
	- ננהל state `didAutoOpen` (`useRef<boolean>` או state ברמת הקומפוננטה) כדי למנוע פתיחה חוזרת.
2. לפני פתיחת המודאל, נוודא שהמשתמש כעת בסקשן המתאים. אם תרצה להזיז אוטומטית לסקשן `skus`, ניתן לקרוא ל־`setActiveSection('skus')` ב־`ProductForm` או להסתמך על כך שהמשתמש כבר הגיע לשם.

### שלב 4: עדכון ממשק משתמש
1. להסיר/להקטין את ה-info box. במקום זאת, ניתן להציג טקסט עזר בראש המודאל מעט לפני השדות (“המערכת פתחה עבורך וריאנט ראשוני — ודא שהמלאי והתמונות נכונים”).
2. להוסיף הסבר קצר מתחת לכותרת הסקשן במצב create: “הוריאנט הראשון נפתח לעריכה כדי להגדיר מלאי ותמונות מותאמים”.
3. לדאוג שהמודאל מכיל שדות חובה (SKU, מלאי, מחיר) עם ולידציה ברורה בעברית.

### שלב 5: טיפול בנתונים לאחר שמירה
1. כאשר המשתמש שומר את ה-SKU במודאל, לשמור אותו ב-state של `ProductSKUs` וגם לעדכן את השדות `stockQuantity` ב־form הראשי לפי סכום ה-SKUs (כדי להציג התאמה בזמן אמת).
2. לשמור את הדגל `didAutoOpen` כך שגם אם המשתמש מוחק את ה-SKU וחוזר למסך ריק, נציג שוב info box או נפתח שוב מודאל (נחליט לפי מדיניות UX — מומלץ לחזור ולפתוח אוטומטית עד שקיים לפחות SKU אחד, כדי לא לאפשר שמירה ללא SKU).

### שלב 6: בדיקות ידניות וצוות QA
1. **תרחיש בסיסי:** יצירת מוצר חדש, מעבר ל־SKUs — לוודא שהמודאל נפתח עם ערכים מהטופס. שמור את המודל → וידוא שה-SKU מופיע ברשימה וכי `stockQuantity` בטופס הראשי הותאם.
2. **תרחיש ביטול:** סגור את המודאל ללא שמירה → ודא שהמערכת מונעת שליחה ללא SKU (ולידציה קיימת) ומציגה הודעה מתאימה.
3. **תרחיש עריכה לאחר שמירה:** לאחר הניווט ל-`/edit`, לוודא שה-SKU שנשמר קיים, כולל תמונות ומלאי.
4. **נגישות:** בדיקת מקלדת (Tab/Shift+Tab, ESC), בדיקת קריאת מסך (ARIA roles ותיאורים) ל-AddSKUModal.

## שיקולי המשכיות ושחזור
- אם בעתיד נרצה לתמוך גם בזרימה של מוצרים עם וריאנטים מרובים, נוודא שהמודאל המוקפץ לא מפריע להוספת וריאנטים נוספים (הכפתור “הוסף וריאנט נוסף” ימשיך לעבוד כרגיל).
- יש לאפשר למשתמש לבחור שלא לקבוע מלאי עכשיו (למשל באמצעות השארת 0) אבל להיות מודע לכך שהמערכת תתריע בעת ניסיון פרסום מוצר ללא מלאי.
- בזמן פיתוח, להוסיף feature flag (`autoOpenInitialSkuModal`) בנתב או בקונפיג, כדי שנוכל לכבות/להדליק לצורכי בדיקות A/B ואם נרצה להשוות ביצועים.

## שלבים הבאים בביצוע
1. עדכון `ProductSKUs.tsx` כדי לנהל את פתיחת המודאל וה-state של `didAutoOpen`.
2. הרחבת `AddSKUModal` לתמיכה בפרופס `initialSku` (אם מלחיד) והצגת טקסט עזר בעברית בראש המודאל.
3. אינטגרציה עם `ProductForm` כדי למשוך ערכי ברירת מחדל עבור SKU (name, basePrice, stockQuantity, images).
4. בדיקות ידניות + תיעוד קצר ב-README/Admin כדי שצוותים עסקיים ידעו על השינוי.

---
תכנית זו מבטיחה התאמה מלאה ללוגיקה הקיימת, משפרת את חוויית ניהול הוריאנטים, ושומרת על תקני נגישות וארכיטקטורה מקצועיים כפי שמצופה ממערכת מסחר אלקטרוני בקנה מידה גדול.
